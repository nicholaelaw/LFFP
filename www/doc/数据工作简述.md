## 数据工作简述

当前的数据工作以整理、统计为主。收到的数据请求又可以分为汇总数据和明细两种类型。接下来尝试将思路和方法如实记录下来。

### 工作环境

目前绝大部分数据工作都是在R中完成。

### 获取数据

当前通过两个途径获取系统数据：网页抓取和接口（API）输出。网页抓取即通过模拟登陆、发送请求、解析结果来获取系统数据；接口输出则是通过内部开发的数据接口，直接发送请求、解析结果。

目前主要的数据项目以及获取方式如下：

- 现金流量表（API）
- 客户明细报表（API）
- 操作日志（API）
- 流程日志（API）
- 提前还款查询（抓取）
- 当日逾期查询（抓取）
- 保证金代偿确认（抓取）

注: 近几月观察发现网页抓取已不可靠，应尽快将此类数据转为API抓取。

### 整理数据

汽车数据经历了一次系统迁移，包含少许错误。在进行统计之前，需要更正这些错误。另外，为方便统计进行，会增加一些辅助字段，也在这个阶段完成。

做出调整的项目如下：

+ 客户明细表
    - 申请编号1000018449，身份证号修正为441881198111258218；
    - 申请编号1000030730，身份证号修正为441223197001183825；
    - 申请编号1000059811，身份证号修正为44122419861128573X；
    - 申请编号1000039317，身份证号修正为450603198108250653；
    - 申请编号1000063474，身份证号修正为130534198511252610；
    - 申请编号1000042054，身份证号修正为43042419940110821X；
    - 申请编号1000018394，身份证号修正为440624197611155727；
    - 申请编号1000043399，身份证号修正为440804198507261638；
    - 申请编号1000051230，身份证号修正为441381199205014712；
    - 申请编号1000059843，身份证号修正为452130197504052746；
    - 申请编号1000057745，身份证号修正为500241198902186610；
    - 申请编号1000039344，身份证号修正为513022196603203092；
    - 申请编号1000484980，合同编号YC2014-043为重复项，对应现金流空白。删除；
    - 对于还款状态``BAHKZC``缺失，单据状态``BASQZC``为「合同已归档」的申请，将还款状态设为「正常还款中」；
    - 对于GPS费用``GPSFY``为空的申请，将其值设为零；
    - 与当日逾期查询匹配后，增加当前是否逾期``DQSFYQ``字段；
    - 根据产品名称，整理并添加产品家族、产品系列字段（对照表另附）；
    - 对于经销商简称``BAKHJC``缺失的申请，将其值设为经销商全称``BAKHMC``；
    - 根据对照表，修正经销商省市、简称；
+ 现金流量表
    - 合同编号CON1712124811的单据状态设为「合同已归档」；
    - 删除单据状态``BASQZC``为「经销商取消」的申请；
    - 删除合同编号YC2014-043项下期数``BBFQXH``为空的多余项；
    - 删除合同编号YC2014-213项下第37期；
    - 合同编号CON1505130066的融资期限``BARZQX``设为36；
    - 合同编号CON1505140070第99期现金流中应含有罚金，应收``BBKHBJ``及实收本金``SSBJ``减去443.99；
    - 合同编号CON1510230428第99期现金流中应含有罚息，应收``BBKHBJ``及实收本金``SSBJ``减去66.29；
    - 对于提前结清的合同，提前结清的现金流之收款日``BBCGRQ``等于结清日，并且对应未收金额清零；
    - 为方便统计，将未发生的现金流之收款日``BBCGRQ``设为2099-12-31；
    - 对于已有收款日，但未收本金不为零的现金流，同样将收款日设为2099-12-31（视作未还款）；
    - 对于非第99期、应收日在数据导出日之前、且收款日在应收日之后的现金流，设置历史逾期标志。
+ 系统日志
    - 对于操作日志，原始单据号``ZADJID``即申请编号``BASQBH``；
    - 解析操作日志中的时间戳``ZACZSJ``；
    - 将操作日志和流程日志合并，称作系统操作日志；
    - 根据任务描述``ZARWMC``及对照表，生成任务编号；
    - 根据状态描述``ZAZTMC``及对照表，生成状态编号；

经过上述流程，得到三个清洗后的基础数据：

- 客户明细报表（已清洗）
- 现金流量表（已清洗）
- 系统操作日志（已清洗）


### 计算衍生数据

从清洗后的基础数据，可预计算常用的衍生数据，目前常备的是汽车历史数据和合同余额数据。计算流程如下：


+ 合同余额数据
    - 根据现金流量表（已清洗），计算导出之日每个合同项下的实收期数、本金、利息、抵扣保证金及罚息。过滤条件为起租日期``BASXRQ``小于导出日、收款日``BBCGRQ``小于导出日；
    - 根据现金流量表（已清洗），计算导出之日每个合同项下的未收期数、本金、利息、未扣保证金及应收罚息。过滤条件为起租日期``BASXRQ``小于导出日、收款日``BBCGRQ``大于等于导出日、期数``BBFQXH``不等于99；
    - 根据现金流量表（已清洗），计算导出之日每个合同项下的逾期期数、最大逾期天数、逾期分类及逾期本金、利息、保证金、罚息。过滤条件为起租日期``BASXRQ``小于导出日、收款日``BBCGRQ``大于等于导出日。
    - 根据现金流量表（已清洗），计算导出之日每个合同项下的累计逾期期数、累计逾期天数、历史最大逾期天数及累计逾期本金、利息、保证金、罚息。过滤条件为起租日期``BASXRQ``小于导出日、逾期天数大于等于1、期数``BBFQXH``不等于99。
    - 根据现金流量表（已清洗），计算合同名义结束日：取最大应收日``BBSKRQ``；
    - 根据现金流量表（已清洗），计算合同实际结束日：取最大收款日``BBCGRQ``；
    - 根据现金流量表（已清洗），计算合同有效结束日：
        - 对于实际结束日不是2099-12-31的，有效结束日等于实际结束日；
        - 对于实际结束日为2099-12-31、名义结束日大于等于导出日的，有效结束日等于名义结束日；
        - 对于实际结束日为2099-12-31、名义结束日小于导出日的，有效结束日等于实际结束日；
    - 将上述流程的结果按申请编号``BASQBH``、合同编号``BAHTBH``合并，生成完整的合同余额数据。
    
汽车历史数据计算过程太过复杂、且用途稀少、预期不再使用，故暂不做说明。

### 固定数据

